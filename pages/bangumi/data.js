// 自定义数据备份
// https://github.com/yixiaojiu/bilibili-bangumi-component/blob/main/docs/custom.md

const customData = {
  anime: {
    done: [
      {
        // 名称
        name: "拒入黑道：和不良少年战斗的日子",
        // 中文名
        nameCN: "拒入黑道：和不良少年战斗的日子",
        // 简介
        summary:
          "有人的地方就有江湖，每一个少年心中自有一个江湖！！当面对黑暗，我们是忍气吞声，还是放手一搏？这里记录了青春和热血，誓言和契约……所有“不良系列”的前传。不良系列，从这里开始……",
        // 封面
        cover: "https://pic.mewhz.com/bangumi/jrhd.webp",
        // 链接
        url: "",
        // 标签
        labels: [
          {
            // 标签名
            label: "类型",
            // 标签值
            value: "小说",
          },
          {
            label: "作者",
            value: "抚琴的人",
          },
          {
            label: "时间",
            value: "2011-06-XX",
          },
        ],
      },
      {
        name: "不良之年少轻狂",
        nameCN: "不良之年少轻狂",
        summary:
          "不良少年，热血轻狂！ 在初中被同学们欺负、排挤了三年的王浩，以为来到城南高中会有所改变，谁知道，在这里却又碰到了初中时的老对头…… 不过这一次，王浩决定改变自己的命运。见证一个原本懦弱无能的好学生，一步步崛起为“坏蛋”的成长史！",
        cover: "https://pic.mewhz.com/bangumi/blznsqk.jpg",
        url: "",
        labels: [
          {
            label: "类型",
            value: "小说",
          },
          {
            label: "作者",
            value: "抚琴的人",
          },
          {
            label: "时间",
            value: "2012-12-17",
          },
        ],
      },
      {
        name: "不良之谁与争锋",
        nameCN: "不良之谁与争锋",
        summary:
          "两年前被我甩的丑逼，现在是我们学校的校花！两年前，她是丑逼，我是男神；两年后，她是校花，我是屌丝。三天被打七次，我也屹立不倒！“你看，我以前能保护你，现在也能保护你。”——左飞 两年后，左飞开始一段热血传奇！",
        cover: "https://b-new.heiyanimg.com/book/15461.jpg",
        url: "https://www.heiyan.com/book/15461",
        labels: [
          {
            label: "类型",
            value: "小说",
          },
          {
            label: "作者",
            value: "抚琴的人",
          },
          {
            label: "时间",
            value: "2014-08-10",
          },
        ],
      },
      {
        name: "龙族",
        nameCN: "龙族",
        summary:
          "他以为他将这样度过一生，他以为他始终只是个衰小孩。但是，一封来自卡塞尔学院的录取通知书改变了他的一生。云层里透出神秘的吟唱：你也有神奇的父母，你也有热血的同伴，你的血管里流动着龙族的血液。而你的目标将是 —— 屠龙。",
        cover: "https://pic.mewhz.com/bangumi/lz.jpg",
        url: "https://book.douban.com/subject/4737329/",
        labels: [
          {
            label: "类型",
            value: "小说",
          },
          {
            label: "作者",
            value: "江南",
          },
          {
            label: "时间",
            value: "2009-10-01",
          },
        ],
      },
      {
        name: "斗破苍穹",
        nameCN: "斗破苍穹",
        summary:
          "讲述了天才少年萧炎在创造了家族空前绝后的修炼纪录后突然成了废人，种种打击接踵而至。就在他即将绝望的时候，一缕灵魂从他手上的戒指里浮现，一扇全新的大门在面前开启，经过艰苦修炼最终成就辉煌的故事。这里是属于斗气的世界，没有花俏艳丽的魔法，有的，仅仅是繁衍到巅峰的斗气！",
        cover: "https://img1.doubanio.com/view/subject/l/public/s34931368.jpg",
        url: "https://book.douban.com/subject/22933018/",
        labels: [
          {
            label: "类型",
            value: "小说",
          },
          {
            label: "作者",
            value: "天蚕土豆",
          },
          {
            label: "时间",
            value: "2009-04-14",
          },
        ],
      },
      {
        name: "全职高手",
        nameCN: "全职高手",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "小说",
          },
          {
            label: "作者",
            value: "蝴蝶兰",
          },
        ],
      },
      {
        name: "神鬼剑士",
        nameCN: "神鬼剑士",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "小说",
          },
          {
            label: "作者",
            value: "突然的光和热",
          },
        ],
      },
      {
        name: "妹妹人生",
        nameCN: "妹妹人生",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "小说",
          },
          {
            label: "作者",
            value: "入间人间",
          },
        ],
      },
      {
        name: "义妹生活",
        nameCN: "义妹生活",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "小说",
          },
          {
            label: "作者",
            value: "三河GHOST",
          },
        ],
      },
      {
        name: "修真聊天群",
        nameCN: "修真聊天群",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "小说",
          },
          {
            label: "作者",
            value: "圣骑士的传说",
          },
        ],
      },
      {
        name: "终极一班",
        nameCN: "终极一班",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "终极一家",
        nameCN: "终极一家",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "终极三国",
        nameCN: "终极三国",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "终极一班2",
        nameCN: "终极一班2",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "终极一班3",
        nameCN: "终极一班3",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "终极一班4",
        nameCN: "终极一班4",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "神话",
        nameCN: "神话",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "爱情公寓",
        nameCN: "爱情公寓",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "爱情公寓2",
        nameCN: "爱情公寓2",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "爱情公寓3",
        nameCN: "爱情公寓3",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "爱情公寓4",
        nameCN: "爱情公寓4",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "爱情是从告白开始的",
        nameCN: "爱情是从告白开始的",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "最好的我们",
        nameCN: "最好的我们",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "三体",
        nameCN: "三体",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "我在未来等你",
        nameCN: "我在未来等你",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "狂飙",
        nameCN: "狂飙",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "我要逆风去",
        nameCN: "我要逆风去",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
      {
        name: "人民的名义",
        nameCN: "人民的名义",
        summary: "",
        cover: "",
        url: "",
        labels: [
          {
            label: "类型",
            value: "电视剧",
          },
        ],
      },
    ],
  },
};
const isMock = false;
function p(t) {
  return Object.entries(t).filter(([, a]) => !!a).map(([a, e]) => `${a}=${e}`).join("&");
}
function f(t) {
  return Object.fromEntries(Array.from(t.searchParams.entries()).filter(([, a]) => !!a));
}
function m(t) {
  let a = t.toString();
  if (a.length < 5) return a;
  if (a.length < 9) {
    let r = a.slice(0, -3), n = r.length, i = r[n - 1] === "0" ? "" : `.${r[n - 1]}`;
    return `${r.slice(0, n - 1)}${i}\u4E07`;
  }
  let e = a.slice(0, -7), o = e.length, s = e[o - 1] === "0" ? "" : `.${e[o - 1]}`;
  return `${e.slice(0, o - 1)}${s}\u4EBF`;
}
function c(t) {
  return Response.json(t, { status: t.code });
}
var v = { 1: "anime", 2: "game", 3: "book" }, j = { 1: "want", 2: "doing", 3: "done" };
function d(t, a) {
  let { subjectType: e = "1", collectionType: o = "0", pageNumber: s = 1, pageSize: r = 10 } = t, n = a[v[e]];
  if (!n) return b(r);
  let i;
  if (o !== "0") {
    let l = n[j[o]];
    if (!l || !l.length) return b(r);
    i = l;
  } else {
    let l = Object.values(n).flat();
    if (!l.length) return b(r);
    i = l;
  }
  return c({
    code: 200,
    message: "ok",
    data: {
      list: i.slice((s - 1) * r, s * r),
      pageNumber: s,
      pageSize: r,
      total: i.length,
      totalPages: Math.ceil(i.length / r),
    },
  });
}
function b(t) {
  return c({ code: 200, message: "ok", data: { list: [], pageNumber: 1, pageSize: t, total: 0, totalPages: 1 } });
}
async function h(t, a) {
  let { collectionType: e = "0", uid: o, pageNumber: s = "1", pageSize: r = "10" } = t, n = o ?? a?.BILIBILI;
  if (!n) return c({ code: 400, message: "uid is required", data: {} });
  let i = p({ type: 1, follow_status: e, pn: s, ps: r, vmid: n }),
    l = await fetch(`https://api.bilibili.com/x/space/bangumi/follow/list?${i}`),
    u = await l.json();
  return l.ok ? c({ code: 200, message: "ok", data: R(u.data) }) : c({ code: 502, message: u.message, data: {} });
}
function R(t) {
  return {
    list: t?.list?.map(e => {
      let o = [
        { label: e?.new_ep?.index_show },
        { label: "\u8BC4\u5206", value: e?.rating?.score },
        { label: "\u64AD\u653E\u91CF", value: e?.stat?.view && m(e.stat.view) },
        { label: "\u8FFD\u756A\u6570", value: e?.stat?.follow && m(e.stat.follow) },
        { label: "\u6295\u5E01\u6570", value: e?.stat?.coin && m(e.stat.coin) },
        { label: "\u5F39\u5E55\u6570", value: e?.stat?.danmaku && m(e.stat.danmaku) },
      ];
      return { nameCN: e.title, summary: e.summary, cover: e.cover, url: e.url, labels: o.filter(s => s.label) };
    }) ?? [],
    pageNumber: t.pn,
    pageSize: t.ps,
    total: t.total,
    totalPages: Math.ceil(t.total / t.ps),
  };
}
var N = { 1: "2", 2: "4", 3: "1" }, x = { 0: null, 1: "1", 2: "3", 3: "2" };
async function y(t, a) {
  let { subjectType: e = "1", uid: o, collectionType: s = "0", pageNumber: r = 1, pageSize: n = 10 } = t,
    i = o ?? a?.BGM;
  if (!i) return c({ code: 400, message: "uid is required", data: {} });
  let l = p({ subject_type: N[e], type: x[s], limit: n, offset: (Number(r) - 1) * Number(n) }),
    u = await fetch(`https://api.bgm.tv/v0/users/${i}/collections?${l}`, {
      headers: {
        "User-Agent": "yixiaojiu/bilibili-bangumi-component (https://github.com/yixiaojiu/bilibili-bangumi-component)",
      },
    }),
    g = await u.json();
  return u.ok
    ? c({ code: 200, message: "ok", data: w(g, { pageNumber: Number(r), pageSize: Number(n) }) })
    : c({ code: 502, message: g.description, data: {} });
}
function w(t, a) {
  return {
    list: t?.data?.map(o => {
      let s = o?.subject,
        r = [{ label: s?.eps && `${s.eps}\u8BDD` }, { label: "\u8BC4\u5206", value: s?.score }, {
          label: "\u6392\u540D",
          value: s?.rank,
        }, { label: "\u65F6\u95F4", value: s?.date }];
      return {
        name: s?.name,
        nameCN: s?.name_cn,
        summary: s?.short_summary,
        cover: s?.images?.large,
        url: s?.id ? `https://bgm.tv/subject/${s?.id}` : "https://bgm.tv/",
        labels: r.filter(n => "value" in n ? n.value : n.label),
      };
    }) ?? [],
    ...a,
    total: t.total,
    totalPages: Math.ceil(t.total / a.pageSize),
  };
}
function S(t) {
  let { pageNumber: a = 1, pageSize: e = 10 } = t;
  return { ...t, pageNumber: Number(a), pageSize: Number(e) };
}
async function F(t) {
  let a = new URL(t.url), e = S(f(a)), o = {};
  try {
    o = env;
  } catch {}
  let s = {};
  try {
    s = customData;
  } catch {}
  return a.pathname.endsWith("bilibili")
    ? await h(e, o)
    : a.pathname.endsWith("bgm")
    ? await y(e, o)
    : a.pathname.endsWith("custom")
    ? d(e, s)
    : Response.json({ code: 404, message: "not found", data: {} }, { status: 404 });
}
export { F as default };